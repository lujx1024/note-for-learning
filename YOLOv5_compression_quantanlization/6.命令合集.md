

[TOC]

# 概述

本文档主要记录YOLOv5模型训练过程中的常用指令合集

# 模型训练

## 基线模型训练

1. 单卡训练

   ```bash
   python train.py --data data/voc_ball.yaml --cfg models/yolov5s_ball.yaml --weights weights/yolov5s.pt --batch-size 16 --epochs 100 --name yolov5s-baseline
   ```

   

2. 多卡训练

   `YOLOv5`支持多卡分布式训练模式，即`Multi-GPU DistributedDataParallel Mode` ,在其他常用参数前添加 `python -m torch.distributed.run --nproc_per_node`, 可启动分布式多卡训练，示例如下：

   ```bash
   python -m torch.distributed.run --nproc_per_node 4 train.py --batch 64 --data coco.yaml --weights yolov5s.pt --device 0,1,2,3
   ```

   - 旧版本`Pytorch`需要将`torch.distributed.run`更换为`torch.distributed.launch`
   - `--nproc_per_node`参数指定使用多少个GPU进行训练，上述示例中使用4个GPU
   - `--batch` 所有`GPU`总的`batch-size`. 训练中由每个`GPU`平均分配.上述示例中,总共每个`GPU`平均分配的`batch-size`为`64 / 4 = 16`个
   - `GPU`的设备序号从`0`开始

## 稀疏化训练

1. 单卡训练

   ```bash
   python train_sparsity.py --st --sr 0.005 --data data/voc_ball.yaml --cfg models/yolov5s_ball.yaml --weights weights/yolov5s.pt --batch-size 16 --epochs 100 --workers 4 --name yolov5s-sparse
   ```

   - 超参数`--sr`需要根据实际情况调整

2. 多卡训练

   ```bash
   python -m torch.distributed.launch --nproc_per_node 4  train_sparsity.py --st --sr 0.0005 --data data/gesture.yaml  --cfg models/yolov5l_gesture.yaml --name yolov5l-gesture-finetined --weights weights/yolov5l.pt   --epochs 300  --device 0,1,2,3 --batch 64
   ```

   

## 剪枝

```bash
python prune.py --data data/voc_ball.yaml --cfg models/yolov5l_ball.yaml --percent 0.5 --weights runs/train/yolov5l-sparse/weights/last.pt 
```

## 微调

1. 单卡训练

   ```bash
   python finetune_pruned.py --weights pruned_model.pt --data data/voc_ball.yaml --batch-size 8 --epochs 100 --name yolov5l-finetuned
   ```

2. 多卡训练

   ```bash
   python -m torch.distributed.launch --nproc_per_node 4  finetune_pruned.py --data data/gesture.yaml --name yolov5l-gesture-finetined --weights pruned_model.pt   --epochs 200  --device 0,1,2,3 --batch 64
   ```


## 性能评估

1. `eval`

   ```bash
   python val.py --data data/voc_ball.yaml --weights runs/train/yolov5l-finetuned/weights/best.pt --batch-size 8
   ```

2. `detect`

   ```bash
   python detect_pruned.py --source ./images/img1.jpg --weights runs/train/yolov5l-finetuned/weights/best.pt
   ```
   

## 模型导出

1. 导出`FP32`精度的`onnx`

   ```bash
   python export.py --weights yolov5s.pt --include onnx
   ```

2. 导出`FP16`精度的`onnx`

   ```bash
   python export.py --weights yolov5s.pt --include onnx --half --device 0
   ```
3. 导出`FP32`精度的`openvino`
   ```bash
   python export.py --weights yolov5s.pt --include openvino
   ```

   